<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="Tabletop RPG Manager" name="description">
    <meta content="Almighty Nassar" name="author">
    <link rel="icon" href="favicon.ico">
    <title>Tabletop Manager</title>
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css" media="all">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap-theme.css" media="all">
    <link rel="stylesheet" type="text/css" href="css/shapies.css" media="all">
    <link rel="stylesheet" type="text/css" href="css/font/fonts.css" media="all">
</head>
<body>
    <div id="gmtm" class="container">
        <!--
        ==================================
            MENU BAR
        ==================================
        -->
        <div class="row">
            <div class="col-md-12 navbar navbar-default">
                <ul class="nav  nav-tabs" role="tablist">
                    <li role="presentation" class="active" id="home-tab">
                        <a href="#home" aria-controls="home" role="tab" data-toggle="tab">Home</a>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">Player<span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li role="presentation" id="dice-tab">
                                <a href="#dice" aria-controls="dice" role="tab" data-toggle="tab">Dice Roller</a>
                            </li>
                            <li role="presentation" id="item-tab">
                                <a href="#item" aria-controls="item" role="tab" data-toggle="tab">Item List</a>
                            </li>
                            <li role="presentation" id="sector-tab">
                                <a href="#sector" aria-controls="sector" role="tab" data-toggle="tab">Sector Viewer</a>
                            </li>
                        </ul>
                    </li>
                    <li role="presentation" class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">GM<span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li role="presentation" id="fictional-tab">
                                <a href="#fictional" aria-controls="fictional" role="tab" data-toggle="tab">Fictional Text</a>
                            </li>
                            <li role="presentation" id="generator-tab">
                                <a href="#generator" aria-controls="generator" role="tab" data-toggle="tab">Generators</a>
                            </li>
                            <li role="presentation" id="markov-tab">
                                <a href="#markov" aria-controls="markov" role="tab" data-toggle="tab">Markov Names</a>
                            </li>
                            <li role="presentation" id="stat-tab">
                                <a href="#stat" aria-controls="stat" role="tab" data-toggle="tab">Stat Blocks</a>
                            </li>
                        </ul>
                    </li>
                    <li role="presentation" class="dropdown">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#">System<span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li role="presentation" id="export-import-tab">
                                <a href="#export-import" aria-controls="markov" role="tab" data-toggle="tab">Export/Import</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
        <!--
        ==================================
            ALERTS
        ==================================
        -->
        <div class="row">
            <div class="col-md-12">
                <gmtm-alert v-for="item in this.alerts" :type="item.type">
                    {{ item.text }}
                </gmtm-alert>
            </div>
        </div>
        <!--
        ==================================
            CONTENT
        ==================================
        -->
        <div class="row">
            <div class="col-md-12 tab-content">
                <!--
                ============================
                HOME
                ============================
                -->
                <div role="tabpanel" class="tab-pane fade in active" id="home">
                    <gem-articulate target="#home-intro"></gem-articulate>
                    <p id="home-intro">
                        Thank you for choosing me, GEM, for all of your management needs! I am your interactive personal guide to the world. In fact, I may just be your most knowledgable resource about this world! To use me, just select your desired option from the menu above. I will always be available to help you along your journey; just click the PLAY button!
                    </p>
                    <hr />
                    <p>
                        <small>
                            <strong>GMTM v0.0.5</strong> <em>by almightynassar. <a href="https://github.com/almightynassar/shapies/">Click here to access the GitHub Repository</a>. This project strives to use open licensed materials only; please support game designers by purchasing licensed material.</em>
                        </small>
                    </p>
                </div>
                <!--
                ============================
                DICE
                ============================
                -->
                <div role="tabpanel" class="tab-pane fade" id="dice">
                    <gem-articulate target="#dice-intro"></gem-articulate>
                    <div id="dice-intro">
                        <p>The dice roller offers the following functions:</p>
                        <ul>
                            <li>roll(number of dice, sides on dice) <em>example: roll(1,20)+2</em></li>
                            <li>drop(number of dice, sides on dice, number to drop, 1=drop highest/0=drop lowest) <em>example: drop(4,6,1,0)</em></li>
                            <li>advantage(number of dice, sides on dice, 1=advantage/0=disadvantage) <em>example: advantage(3,20,0)</em></li>
                        </ul>
                    </div>
                    <div class="well">
                        <h4>Saved Dice</h4>
                        <gmtm-dice v-for="dice in this.dice" :dice="dice" v-on:dice-remove="diceRemove" v-on:dice-load="diceLoad"></gmtm-dice>
                    </div>
                    <div id="dice-controls" class="form">
                        <div class="form-group">
                            <label>Formula:</label>
                            <input type="text" class="form-control" v-model="diceFormula" />
                        </div>
                        <div class="form-group">
                            <label>Notes (descriptor for the log history):</label>
                            <input type="text" class="form-control" v-model="diceNotes" />
                        </div>
                        <div class="form-group">
                            <label>Name (Only used for saving dice formula):</label>
                            <input type="text" class="form-control" v-model="diceName" />
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary" v-on:click='diceRoll();'>Roll!</button>
                            <button class="btn btn-success" v-on:click="diceSave();">Save Dice</button>
                        </div>
                    </div>
                    <hr />
                    <div id="DiceResults">
                    </div>
                </div>
                <!--
                ============================
                ITEMS
                ============================
                -->
                <div role="tabpanel" class="tab-pane fade" id="item">
                    <gem-articulate target="#item-intro"></gem-articulate>
                    <div id="item-intro">
                        <p>This section allows you to explore the equipment available to you and your character.</p>
                    </div>
                    <div id="ItemForm" class="form" >
                        <div class="form-group">
                            <label>Type:</label>
                            <select id="item_type" class="form-control" onChange="ItemSearch();"></select>
                        </div>
                        <div class="form-group">
                            <label>Tech-level of market:</label>
                            <select id="item_tech" class="form-control" onChange="ItemSearch();">
                                <option value="0">Stone (primitive hunter and gather tools)</option>
                                <option value="1">Ancient (simple metals; arithmetic; writing)</option>
                                <option value="2">Medieval (steel; calculus; books)</option>
                                <option value="3">Industrial (steam; mechanical calculators; telegraph)</option>
                                <option value="4">Mechanized (fossil fuels; electrical calculators; radio)</option>
                                <option value="5">Digital (renewable energy; personal computers; networking)</option>
                                <option value="6">Robotic (nanotech; artificial intelligence; human-machine interfaces)</option>
                                <option value="7">Interstellar (space travel)</option>
                                <option value="8">Exotic (extremely high-tech)</option>
                            </select>
                        </div>
                    </div>
                    <hr />
                    <div>
                        <table class="table table-bordered table-stripe">
                            <thead>
                                <tr>
                                    <td>Item</td>
                                    <td>Tech</td>
                                    <td>Weight (kg)</td>
                                    <td>Cost (Base)</td>
                                    <td>Cost (Adj.)</td>
                                    <td>Rules</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!--
                ============================
                SECTOR VIEWER
                ============================
                -->
                <div role="tabpanel" class="tab-pane fade" id="sector">
                    <gem-articulate target="#sector-intro"></gem-articulate>
                    <div id="sector-intro">
                        <p>Allows us to manage a sector.</p>
                    </div>
                    <div id="SectorMap" >
                        <img id="hexmap" height="820" width="563" style="display: block; margin-left: auto; margin-right: auto;" src="img/hexmap.png">
                    </div>
                </div>
                <!--
                ============================
                FICTIONAL TEXT
                ============================
                -->
                <div role="tabpanel" class="tab-pane fade" id="fictional">
                    <gem-articulate target="#fictional-intro"></gem-articulate>
                    <div id="fictional-intro">
                        <p>This convertor uses a Font File to convert english text to it's fantasy script counter-part. The convertor is mapped <strong>exactly</strong> as it would be if you downloaded and installed the font onto your computer (in fact, I recommend you do that for best results). This convertor is pretty much only good for previewing the fantasy fonts.</p>
                    </div>
                    <div id="FictionalLanguage" class="well"></div>
                    <div id="fictional-controls" class="form" >
                        <div class="form-group">
                            <label>Font:</label>
                            <select class="form-control" v-model="fictionalSelect" v-on:change="fictionalInform()">
                                <option v-for="font in this.font" :value="font.font" >{{ font.name }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Font Size (pt):</label>
                            <input type="number" class="form-control"  v-model="fictionalSize" />
                        </div>
                        <div class="form-group">
                            <label>Canvas length (em):</label>
                            <input type="number" class="form-control"  v-model="fictionalLength" />
                        </div>
                        <div class="form-group">
                            <label>Canvas width (em):</label>
                            <input type="number" class="form-control"  v-model="fictionalWidth" /></p>
                        </div>
                        <div class="form-group">
                            <textarea class="form-control" v-model="fictionalInput" ></textarea>
                        </div>
                        <button class="btn btn-block btn-lg btn-primary" v-on:click='fictionalConvert();'>Convert</button>
                    </div>
                    <hr />
                    <div id='FictionalResult' style="height:20em;width:20em;border-style:solid;border-width:1px;" >
                        <canvas id="Result" width="100%" height="100%"></canvas>
                    </div>
                </div>
                <!--
                ============================
                MARKOV
                ============================
                -->
                <div role="tabpanel" class="tab-pane fade" id="markov">
                    <gem-articulate target="#markov-intro"></gem-articulate>
                    <div id="markov-intro">
                        <p>This system is based on the Markov Chain process. It gathers information about how the letters in words are related, and then stores those relationships. When you generate a name, the computer will use this information to create a new word that is <em>in the style of the processed words</em>. This generally makes up a nonsense word that is similar in style to the other words. The more words you give the system to analyse, the better it will be at generating new words!</p>
                    </div>
                    <div class="form">
                        <div class="form-group">
                            <label>Chain:</label>
                            <select class="form-control" v-model="markovInput" v-on:change="markovLoad();">
                                <option v-for="obj in this.markovTransformed" :value="obj.race+'-'+obj.gender">{{obj.race}} {{obj.gender}}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label># names to generate:</label>
                            <input type="number" v-model="markovNumber" class="form-control" />
                        </div>
                        <div class="form-group">
                            <label>Standard name Length:</label>
                            <input type="number" v-model="markovLength" class="form-control" />
                        </div>
                        <button class="btn btn-block btn-lg btn-dnd" v-on:click='markovGenerate();'>Generate</button>
                    </div>
                    <div id="Markov-Result" class="well" >
                    </div>
                </div>
                <!--
                ============================
                EXPORT / IMPORT
                ============================
                -->
                <div role="tabpanel" class="tab-pane fade" id="export-import">
                    <gem-articulate target="#export-import-intro"></gem-articulate>
                    <div id="export-import-intro">
                        <p>Here we can simply and easily share data with friends. 'Save' will store all your changes so that you can look at it later. 'Export' will create a link to a downloadable file. To import a file, click on the file input and select the file. The contents will be displayed in the text box for review. Then click on either 'Overwrite' or 'Merge' to finalise the import. <strong>Reset will clear EVERYTHING in the database, and is irreversible</strong>.</p>
                    </div>
                    <hr />
                    <div id="export-import-modules">
                        <h4>Module</h4>
                        <gmtm-modules v-for="module in this.config.modules" :type="module" v-on:module-changed="modulesToggle"></gmtm-modules>
                    </div>
                    <hr />
                    <div id="export-import-control">
                        <h4>Display</h4>
                        <div class="form-group">
                            <input type="file" class="form-control" enctype="multipart/form-data" v-on:change='modulesHandleFile' />
                        </div>
                        <div class="form-group">
                            <textarea v-model="exportimport" class="form-control" rows=20></textarea>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-success" v-on:click="modulesView()">View Local</button>
                            <button class="btn btn-success" v-on:click="modulesSave( checkedModules );">Save Local</button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary" v-on:click="modulesDownload( checkedModules );">Export Local</button>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-danger" v-on:click="modulesReset();">Factory Defaults</button>
                            <button v-on:click='modulesImport(true);' class="btn btn-warning">Overwrite Local with Text</button>
                            <button v-on:click='modulesImport(false);' class="btn btn-info">Merge Local with Text</button>
                        </div>
                    </div>
                    <hr />
                </div>
            </div>
        </div>
    </div>
    <!-- 3rd Party libraries -->
    <script src="js/lib/jquery.js"></script>
    <script src="js/lib/vue.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script src="js/lib/articulate.js"></script>
    <script src="js/init.js"></script>
    <!-- Default data functions -->
    <script src="js/data/config.js"></script>
    <script src="js/data/dice.js"></script>
    <script src="js/data/font.js"></script>
    <script src="js/data/generator.js"></script>
    <script src="js/data/item.js"></script>
    <script src="js/data/markov.js"></script>
    <script src="js/data/words.js"></script>
    <!-- Custom objects -->
    <script src="js/object/dice.js"></script>
    <script src="js/object/markov.js"></script>
    <script src="js/object/parser.js"></script>
    <!-- Vue.js app and components -->
    <script type="text/javascript" >
        const techLevels = [
            "Stone",
            "Ancient",
            "Medieval",
            "Industrial",
            "Mechanized",
            "Digital",
            "Robotic",
            "Interstellar",
            "Exotic",
        ];
        /*===================
         * GEM
         *===================
         */
        Vue.component('gem-articulate', {
            props: ['target'],
            template: '<div class="gem-controls" v-if="enabled()">\
                <div class="btn-group btn-group-sm">\
                    <button class="btn btn-success" v-on:click="speak()">Play</button>\
                    <button class="btn btn-warning" v-on:click="pause()">Pause</button>\
                    <button class="btn btn-danger" v-on:click="stop()">Stop</button>\
                </div>\
                <hr />\
            </div>',
            methods: {
                enabled: function() {
                    return $().articulate('enabled');
                },
                speak: function () {
                    if ( $().articulate('isSpeaking') ) {
                        $().articulate('resume');
                    } else {
                        $(this.target).articulate('speak');
                    }
                },
                stop: function() {
                    $().articulate('stop');
                },
                pause: function() {
                    $().articulate('pause');
                }
            }
        });
        /*===================
         * ALERTS
         *===================
         */
        Vue.component('gmtm-alert', {
            props: {
                type: { default: 'info' },
            },
            computed: {
                class: function () {
                    return 'alert alert-'+this.type;
                },
            },
            template: '<p :class="this.class">\
                <slot></slot>\
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>\
            </p>'
        });
        /*===================
         * DICE
         *===================
         */
        Vue.component('gmtm-dice', {
            props: {
                dice: { default: function() { return {}; } },
            },
            methods: {
                eventLoad: function ( local_name) {
                    this.$emit( 'dice-load', local_name );
                },
                eventRemove: function ( local_name) {
                    this.$emit( 'dice-remove', local_name );
                }
            },
            template: '<p>\
                <span class="btn-group btn-group-sm">\
                    <button v-on:click="eventLoad(dice.name);" class="btn btn-xs btn-info">Load</button>\
                    <button v-on:click="eventRemove(dice.name);" class="btn btn-xs btn-danger">Delete</button>\
                </span>\
                <b>{{ dice.name }}:</b> {{ dice.formula }} <em>{{ this.dice.note }}</em>\
            </p>'
        });
        /*===================
         * MODULES CHECKLIST
         *===================
         */
        Vue.component('gmtm-modules', {
            props: {
                type: { default: 'config' },
            },
            computed: {
                elementId: function () {
                    return "module-"+this.type;
                },
            },
            methods: {
                eventChange: function ( local_type ) {
                    this.$emit( 'module-changed', local_type );
                }
            },
            template: '<div class="form-group checkbox">\
                <input :id="elementId" :value="type" v-on:change="eventChange(type)" type="checkbox" /> {{ type }}\
            </div>'
        });
        /*===================
         * GMTM MAIN VUE APP
         *===================
         */
        var gmtm = new Vue({
            el: '#gmtm',
            data: {
                // System data
                alerts: [
                    {
                        type: 'warning',
                        text: 'Cleaning out your cookies will delete ALL stored data! You must save any changes by going to the \'Misc\' > \'Export / Import\' function. Otherwise all changes will be cleared the next time you visit.'
                    }
                ],
                checkedModules: [],
                diceFormula: 'roll(1,20)',
                diceName: 'Generic Roll',
                diceNotes: '',
                exportimport: '',
                fictionalInput: 'please enter your text here that you wish to convert (note that this may not rewrite special characters like !;:= or capitals). see the scripts notes for script-specific translation details',
                fictionalSelect: '',
                fictionalSize: '22',
                fictionalLength: '20',
                fictionalWidth: '20',
                markovInput: '',
                markovNumber: 5,
                markovLength: 7,
                // Important sub-systems
                diceParser: new Parser(),
                markovSystem: new Markov(),
                // User data
                config: InitMake('config', true),
                dice: InitMake('dice'),
                font: InitMake('font'),
                generator: InitMake('generator', true),
                item: InitMake('item'),
                markov: InitMake('markov', true),
                words: InitMake('words', true),
            },
            computed: {
                markovTransformed: function() {
                    var returnArray = [];
                    for (var race in this.markov) {
                        if (this.markov.hasOwnProperty(race)) {
                            for (var gender in this.markov[race]) {
                                if (this.markov[race].hasOwnProperty(gender)) {
                                    returnArray.push( {
                                        race: race,
                                        gender: gender
                                    });
                                }
                            }
                        }
                    }
                    return returnArray;
                }
            },
            methods: {
                dataOutput : function (modules) {
                    var local_data = {};
                    if ( Array.isArray(modules) ) {
                        for (var i = 0; i < modules.length; i++) {
                            var copy = this.dataOutput(modules[i]);
                            local_data = Object.assign(local_data, copy);
                        }
                    } else if (modules) {
                        local_data[modules] = this[modules];
                    }
                    return local_data;
                },
                diceLoad: function (diceName) {
                    var index = this.dice.findIndex(function(obj) { return obj.name === diceName; });
                    if (this.dice[index]) {
                        this.diceFormula = this.dice[index].formula;
                        this.diceName = this.dice[index].name;
                        this.diceNotes = this.dice[index].note;
                    }
                },
                diceRemove: function ( diceName ) {
                    var index = this.dice.findIndex(function(obj) { return obj.name === diceName; });
                    if ( index >=0 ) {
                        this.dice.splice(index, 1);
                    }
                },
                diceRoll: function () {
                    var result = this.diceParser.parse(this.diceFormula).evaluate({roll: Dice.roll, drop: Dice.drop, advantage: Dice.advantage});
                    $("#DiceResults").prepend("<p>" + this.diceFormula + " = <label class='label label-info'>"+result+"</label></p><p><em>"+this.diceNotes+"</em></p><hr />");
                },
                diceSave: function () {
                    this.dice.push( CreateDice( this.diceName, this.diceFormula, this.diceNotes ) );
                },
                fictionalConvert: function () {
                    $('#FictionalResult').height(this.fictionalLength + 'em');
                    $('#FictionalResult').width(this.fictionalWidth + 'em');
                    $('#FictionalResult #Result')[0].width = $('#FictionalResult').width();
                    $('#FictionalResult #Result')[0].height = $("#FictionalResult").height();
                    this.fictionalWrite(this.fictionalInput, this.fictionalSelect, this.fictionalSize);
                },
                fictionalInform: function () {
                    var select = this.fictionalSelect;
                    var index = this.font.findIndex(function(obj) {
                        return obj.font === select;
                    });
                    if ( index >= 0 ) {
                        var returnHtml = "<p>\
                            <strong>"+this.font[index].name+"</strong> (<em>"+this.font[index].from+"</em>)\
                        </p>\
                        <p>\
                            <a href='css/font/"+index+"/"+index+".ttf'>TTF Font file</a>\
                        </p>\
                        <p>"+this.font[index].what+"</p>\
                        <p>"+this.font[index].notes+"</p>";
                        if (!$.isEmptyObject(this.font[index].missing)) {
                            returnHtml += "<p>The following letters were missing from the alphabet and have been replaced:</p><ul>";
                            for (var key in this.font[index].missing) {
                                returnHtml += "<li>"+key+" = "+this.font[index].missing[key]+"</li>";
                            }
                            returnHtml += "</ul>";
                        }
                        if (!$.isEmptyObject(this.font[index].mapping)) {
                            returnHtml += "<p>The following sounds are mapped to the following letters (note that case is important!):</p><ul>";
                            for (var key in this.font[index].mapping) {
                                returnHtml += "<li>"+key+" = "+this.font[index].mapping[key]+"</li>";
                            }
                            returnHtml += "</ul>";
                        }
                        $('#FictionalLanguage').html(returnHtml);
                        //this.fictionalConvert();
                    } else {
                        $('#FictionalLanguage').html('');
                    }
                },
                fictionalResetCanvas: function () {
                    // Store the current transformation matrix
                    $('#FictionalResult #Result')[0].getContext("2d").save();
                    // Use the identity matrix while clearing the canvas
                    $('#FictionalResult #Result')[0].getContext("2d").setTransform(1, 0, 0, 1, 0, 0);
                    $('#FictionalResult #Result')[0].getContext("2d").clearRect(0, 0, $('#FictionalResult #Result')[0].width, $('#FictionalResult #Result')[0].height);
                    // Restore the transform
                    $('#FictionalResult #Result')[0].getContext("2d").restore();
                },
                fictionalWrite: function (text, script, size) {
                    this.fictionalResetCanvas();
                    $('#FictionalResult #Result')[0].getContext("2d").font = size+"px "+script;
                    this.fictionalWrapText(text, 10, size, $('#FictionalResult #Result')[0].width, size);
                },
                fictionalWrapText: function (text, x, y, maxWidth, lineHeight) {
                    x = parseInt(x, 10);
                    y = parseInt(y, 10);
                    maxWidth = parseInt(maxWidth, 10);
                    lineHeight = parseInt(lineHeight, 10);
                    var words = text.split(' ');
                    var line = '';
                    for(var n = 0; n < words.length; n++) {
                        var testLine = line + words[n] + ' ';
                        var metrics = $('#FictionalResult #Result')[0].getContext("2d").measureText(testLine);
                        var testWidth = metrics.width;
                        if (testWidth > maxWidth && n > 0) {
                            $('#FictionalResult #Result')[0].getContext("2d").fillText(line, x, y);
                            line = words[n] + ' ';
                            y += lineHeight;
                        } else {
                            line = testLine;
                        }
                    }
                    $('#FictionalResult #Result')[0].getContext("2d").fillText(line, x, y);
                },
                markovGenerate: function () {
                    var text = "";
                    for (var i = 0; i < this.markovNumber; i++) {
                        var new_name = this.markovSystem.make(1,this.markovLength);
                        text += "<p>" + new_name.charAt(0).toUpperCase() + new_name.slice(1); + "</p>";
                    }
                    $('#Markov-Result').html(text);
                },
                markovLoad: function () {
                    if ( this.markovInput !== this.markovSystem.current()) {
                        var input = this.markovInput.split("-");
                        if (this.config.debug) {
                            console.log('Loading names from : '+input[0]+' '+input[1]);
                        }
                        this.markovSystem.load(this.markov[input[0]][input[1]], this.markovInput);
                    }
                },
                modulesDownload: function ( modules ) {
                    var local_data = this.dataOutput( modules );
                    if ( local_data ) {
                        location.href = 'data:application/octet-stream,' + encodeURIComponent( JSON.stringify(local_data, null, 2) );
                    }
                },
                modulesHandleFile: function (e) {
                    var files = e.target.files || e.dataTransfer.files;
                    if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
                        console.log('The File API is not fully supported in this browser.');
                        return;
                    }
                    if (!files.length) {
                        console.log("Couldn't find the file input element.");
                        return;
                    } else if (!files[0]) {
                        console.log("Please select a file before clicking 'Load'");
                        return;
                    }
                    else {
                        file = files[0];
                        var filereader = new FileReader();
                        var local_vue_instance = this;
                        filereader.onload = function() {
                            if ( filereader.readyState == 2 ) {
                                local_vue_instance.exportimport = filereader.result;
                            } else {
                                console.log( filereader.error );
                            }
                        };
                        filereader.readAsText(file);
                    }
                },
                modulesImport: function( overwrite ) {
                    var local_string = this.exportimport.replace(/\s+|\r?\n|\r/g,' ').trim();
                    var local_json = JSON.parse( local_string );
                    for (var i = 0; i < this.checkedModules.length; i++) {
                        if ( local_json[ this.checkedModules[i]]) {
                            if (overwrite) {
                                this[ this.checkedModules[i] ] = local_json[ this.checkedModules[i] ];
                            } else {
                                if ( Array.isArray( this[ this.checkedModules[i] ] ) ) {
                                    this[ this.checkedModules[i] ].concat( local_json[ this.checkedModules[i] ] );
                                } else {
                                    Object.assign(this[ this.checkedModules[i] ], local_json[ this.checkedModules[i] ]);
                                }
                            }
                        }
                    }
                    alert("Import Complete! Note: Changes have not been saved");
                },
                modulesReset: function () {
                    localStorage.clear();
                    // User data
                    this.config = InitMake('config', true);
                    this.dice = InitMake('dice');
                    this.font = InitMake('font');
                    this.item = InitMake('item');
                    this.markov = InitMake('markov', true);
                },
                modulesSave: function ( modules ) {
                    if ( Array.isArray( modules ) ) {
                        for (var i = 0; i < modules.length; i++) {
                            this.modulesSave( modules[i] );
                        }
                    } else if ( modules ) {
                        localStorage.setItem(modules, JSON.stringify(this[modules]));
                    } else {
                        this.modulesSave(this['module']);
                    }
                },
                modulesToggle: function ( type ) {
                    var index = this.checkedModules.indexOf(type);
                    if ( index > -1) {
                        delete this.checkedModules[index];
                    } else {
                        this.checkedModules.push( type );
                    }
                },
                modulesView: function () {
                    var local_data = this.dataOutput( this.checkedModules );
                    if ( local_data ) {
                        this.exportimport = JSON.stringify(local_data, null, 2);
                    } else {
                        this.exportimport = '';
                    }
                }
            },
            mounted: function() {
                // Stops articulate playback on tab change
                $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
                    if ( $().articulate('isSpeaking') ) {
                        $().articulate('stop');
                    }
                });
                // Loads our fonts
                for(f in this.font) {
                    $('#FictionalResult #Result')[0].getContext("2d").font = "20px "+this.font[f].font;
                    $('#FictionalResult #Result')[0].getContext("2d").fillText('Test',0,0);
                }
                // Sets up our canvas
                $('#FictionalResult #Result')[0].width = $('#FictionalResult').width();
                $('#FictionalResult #Result')[0].height = $("#FictionalResult").height();
                this.fictionalResetCanvas();
            }
        });
        /*===================
         * ITEMS
         *===================
         */
        function ItemUniqueTypes() {
            var unique = [];
            for (var item in gmtm['item']) {
                if (gmtm['item'].hasOwnProperty(item)) {
                    if (unique.indexOf(gmtm['item'][item].type) < 0) {
                        unique.push(gmtm['item'][item].type);
                    }
                }
            }
            return unique;
        }
        function ItemPopulateForm() {
            var unique = ItemUniqueTypes();
            for (var i = 0; i < unique.length; i++) {
                var $elem = $("<option>", {
                    value: unique[i]
                }).html(unique[i]);
                $elem.appendTo( $('#item_type') );
            }
        }
        function ItemConvertTechNumber(tech) {
            switch (tech) {
                case 0: return "Stone";
                case 1: return "Ancient";
                case 2: return "Medieval";
                case 3: return "Industrial";
                case 4: return "Mechanized";
                case 5: return "Digital";
                case 6: return "Robotic";
                case 7: return "Interstellar";
                case 8: return "Exotic";
            }
            return "Unknown";
        }
        function ItemAdjustCost(market,tech,cost) {
            if (market > tech) {
                return Math.round(cost / Math.round((market-tech)/2));
            } else if (market < tech) {
                return Math.round(cost * Math.pow(tech-market, 2));
            }
            return cost;
        }
        function ItemSearch() {
            $('#ItemResult table tbody').html('');
            var item_tech = $('#item_tech').val();
            var items = gmtm['item'].filter( function(obj) { return obj.type === $('#item_type').val(); } );
            for (var item in items) {
                if (items.hasOwnProperty(item)) {
                    //Item    Tech    Weight (kg)    Cost (Base)    Cost (Adj.)    Rules    Description
                    var $elem = $("<tr>", {id: item}).html('<td>'+items[item].name+'</td><td>'+ItemConvertTechNumber(items[item].tech)+'</td><td>'+items[item].weight+'</td><td>'+items[item].cost+'</td><td>'+ItemAdjustCost(item_tech,items[item].tech,items[item].cost)+'</td><td>'+items[item].detail+'</td><td>'+items[item].description+'</td>');
                    $elem.appendTo( $('#ItemResult table tbody') );
                }
            }
        }
        ItemPopulateForm();
        ItemSearch();
    </script>
</body>
</html>
